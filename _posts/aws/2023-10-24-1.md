---
title: "AWS RDS 사용법 / RDS 생성, 설정, DB 백업 및 복원 방법 / RDS DB 오류 해결"
excerpt: ""

categories:
  - AWS
tags:
  - []

permalink: /aws/2023-10-24-1

toc: true
toc_sticky: true

date: 2023-10-24
last_modified_at: 2023-10-24
---

## AWS RDS 생성 방법

### RDS용 VPC 보안그룹 생성
VPC > Security Groups Create > security group
<table>
  <tbody>
    <tr>
      <td>Security group name</td>
      <td>DB-SG 입력</td>
    </tr>
    <tr>
      <td>Description</td>
      <td>Database Security Group 입력</td>
    </tr>
    <tr>
      <td>VPC</td>
      <td>VPC-Lab-vpc 선택</td>
    </tr>
    <tr>
      <td>Inbound rules &gt; Add rule</td>
      <td>유형 : MSSQL 선택<br>소스 : Aanwhere-IPv4 입력</td>
    </tr>
    <tr>
      <td>Outbound rules (기본값)</td>
      <td>유형 : 모든 트래픽<br>대상 : 0.0.0.0/0</td>
    </tr>
  </tbody>
</table>
위와 같이 입력 후, Create security group 클릭하여 보안그룹을 생성합니다.

### AWS RDS 생성 방법 (MSSQL)
RDS > Create database
<table>
  <tbody>
    <tr>
      <td>Choose a database creation method</td>
      <td>Standard create 선택</td>
    </tr>
    <tr>
      <td>Engine type</td>
      <td>Microsoft SQL Server 선택</td>
    </tr>
    <tr>
      <td>Database management type</td>
      <td>Amazon RDS 선택</td>
    </tr>
    <tr>
      <td>Edition</td>
      <td>SQL Server Express Edition 선택</td>
    </tr>
    <tr>
      <td>Engine versions</td>
      <td>SQL Server 2014 12.00.6439.10v1 선택</td>
    </tr>
    <tr>
      <td>Templates</td>
      <td>Dev/Test 선택</td>
    </tr>
    <tr>
      <td>Settings</td>
      <td>DB instance identifier : DB명 입력,<br>Master username : 마스터유저명 입력,<br>Master password : 마스터유저비밀번호 입력</td>
    </tr>
    <tr>
      <td>Instance configuration</td>
      <td>버스터블 클래스 선택 &gt; db.t3.micro 선택 (개발 DB 기준)</td>
    </tr>
    <tr>
      <td>Storage</td>
      <td>스토리지 유형 : 범용 SSD(ap2) 선택<br>스토리지 : 200 GiB 입력</td>
    </tr>
    <tr>
      <td>Virtual private cloud (VPC)</td>
      <td>RDS DB가 위치할 VPC 선택</td>
    </tr>
    <tr>
      <td>DB 서브넷 그룹</td>
      <td>RDS DB가 위치할 서브넷 선택</td>
    </tr>
    <tr>
      <td>Existing VPC security groups</td>
      <td>DB-SG 선택, default 삭제</td>
    </tr>
    <tr>
      <td>가용 영역</td>
      <td>RDS DB가 위치할 가용 영역 선택</td>
    </tr>
  </tbody>
</table>
위와 같이 입력 후 Create database로 RDS를 생성하면 엔드포인트로 접근할 수 있습니다.

### DB 퍼블릭 액세스 가능 설정
RDS > 데이터베이스 > DB 선택 > Modify(수정) > Connectivity(연결) : Additional configuration(추가 구성) 선택 > Publicly accessible(퍼블릭 액세스 가능) 체크 > Continue(계속)
위 설정을 하지 않으면, DB 툴에서 DB에 접근할 수 없습니다.

---

## AWS RDS 설정 방법

### 파라미터 설정 방법





---

## AWS RDS에 .bak 파일 복원 방법

### .bak 파일 업로드용 S3 버킷 생성
버킷명 입력 > RDS DB의 리전(ap-northeast-2b : 서울)과 같은 리전 선택 > 퍼블릭 액세스 차단 전부 풀고 > 암호화 키 유형 : Amazon S3 관리형 키(SSE-S3) 선택 > 버킷 키 비활성화 >  객체 잠금 비활성화 > 버킷 만들기

### RDS에서 S3에 접근 가능한 공용 IAM 역할 생성
IAM > 액세스 관리 > 역할 > 역할 만들기
<table>
  <tbody>
    <tr>
      <td>신뢰할 수 있는 엔터티 유형</td>
      <td>AWS 서비스 선택</td>
    </tr>
    <tr>
      <td>다른 AWS 서비스의 사용 사례</td>
      <td>사용 사례를 조회할 서비스 선택 &gt; RDS &gt; RDS - Add Role to Database 선택</td>
    </tr>
  </tbody>
</table>
위와 같이 선택 후 다음 > AmazonS3FullAccess (모든 S3 리소스에 대한 모든 액세스 가능 정책) 검색하여 선택 후 다음 > 역할 이름 : AddDatabaseRoleRDS-S3 입력 후 저장

### RDS 옵션 그룹 생성
RDS > 옵션 그룹 > 그룹 생성
<table>
  <tbody>
    <tr>
      <td>이름</td>
      <td>NativeBackupRestore-프로젝트명 입력</td>
    </tr>
    <tr>
      <td>설명</td>
      <td>Option group to restore backup from S3 bucket 입력</td>
    </tr>
    <tr>
      <td>엔진</td>
      <td>sqlserver-ex 선택</td>
    </tr>
    <tr>
      <td>메이저 엔진 버전</td>
      <td>12.00 선택</td>
    </tr>
  </tbody>
</table>

### 생성된 옵션 그룹 선택 후 옵션 추가
<table>
  <tbody>
    <tr>
      <td>옵션 이름</td>
      <td>SQLSERVER_BACKUP_RESTORE (SQL Server의 기본 백업/복원에 대해 사용합니다. 백업 파일을 저장하려는 S3 위치에 대한 액세스 권한을 IAM 역할을 통해 DB 인스턴스에 부여합니다.) 선택</td>
    </tr>
    <tr>
      <td>IAM 역할</td>
      <td>생성했던 IAM 역할 AddDatabaseRoleRDS-S3 선택</td>
    </tr>
    <tr>
      <td>옵션 추가 예약</td>
      <td>즉시 선택</td>
    </tr>
  </tbody>
</table>
위와 같이, 옵션 그룹에 SQLSERVER_BACKUP_RESTORE 옵션 활성화, IAM 역할 부여가 필요합니다.

### RDS DB 옵션 그룹 변경
RDS > 데이터베이스 > DB 선택 > 수정 > 추가구성 > 옵션 그룹 : NativeBackupRestore-프로젝트명 선택 후 계속 > 즉시 적용 선택 > DB 인스턴스 수정

### S3 버킷에 .bak 파일 업로드
S3 > 생성했던 S3 버킷 선택 > 업로드 > 파일 추가 후 .bak 파일 추가

### S3 버킷에서 백업 복원 명령어
```
exec msdb.dbo.rds_restore_database
@restore_db_name='복원할DB명',
@s3_arn_to_restore_from='arn:aws:s3:::S3버킷명/DB백업파일명.bak';
```
DBeaver 또는 SSMS에서 위 쿼리 실행하면 복원이 완료됩니다.

### 현재 백업 및 복원 상태 확인 명령어
```
exec msdb.dbo.rds_task_status @db_name='DB명';
```
% complete : 100%, lifecycle : SUCCESS으로 나오면 복원 성공입니다.

<mark>옵션 미설정 시 에러메세지</mark>
```
Database backup/restore option is not enabled yet or is in the process of being enabled. Please try again later.
```
복원 실패하면 RDS에 옵션 설정이 제대로 되어있는지 확인해야 합니다.

### .bak 파일 백업 명령어
```
exec msdb.dbo.rds_backup_database 
@source_db_name='백업할DB명', 
@s3_arn_to_backup_to='arn:aws:s3:::S3버킷명/DB백업파일명.bak',
@overwrite_S3_backup_file=1;
```
S3 버킷에 DB를 백업할 수 있는 명령어입니다.

---

## RDS DB 오류 해결

### 프로시저 function 생성 시 오류 해결

<mark>프로시저 생성 시 오류</mark>
```
SQL Error [1418] [HY000]: (conn=140) This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)
```
위와 같은 오류가 나오면, DB에 연결된 파라미터 그룹에서 log_bin_trust_function_creators 값을 1로 변경 후 다시 실행하면 됩니다.

<mark>쿼리에 명시한 프로시저가 속할 계정이 없는 경우</mark>
```
SQL Error [1227] [42000]: (conn=140) Access denied; you need (at least one of) the SUPER, SET USER privilege(s) for this operation
```
프로시저 생성 쿼리에서 DEFINER='유저명'@'%'을 빼거나, 해당 유저를 생성한 뒤 다시 시도하면 됩니다.

### 쿼리 대소문자 오류 해결
<mark>쿼리는 대문자인데 실제 테이블이 소문자인 경우</mark>
```
Table 'DB명.테이블명(대문자)' doesn't exist
```

<mark>대소문자 구분 여부 확인</mark>
```
show variables like 'lower_case_table_names';
```
기본값 0으로 되어있으면 쿼리에서 대소문자를 구분하여 실행하기 때문에 소문자 테이블은 찾을 수 없다고 나옵니다.  
DB에 연결된 파라미터 그룹에서 lower_case_table_names를 1로 변경 후 재부팅하면 해결됩니다.

<mark>MySQL 버전 확인</mark>
```
SELECT version();
```
MySQL 8.0은 lower_case_table_names를 1로 설정할 수 없기 때문에 변경 시 아래의 에러 메세지가 나옵니다.
```
The parameter value for lower_case_table_names can't be changed for MySQL 8.0 DB instances.
```
꼭 이 기능을 써야 한다면, 다른 버전으로 재설치하여 다시 구축해야 합니다.

---
title: "자주 쓰는 MariaDB 쿼리 정리 / MySQL 사용법"
excerpt: ""

categories:
  - 기획 / 설계 / DB
tags:
  - []

permalink: /plan-design-db/2023-05-30-1

toc: true
toc_sticky: true
 
date: 2023-05-30
last_modified_at: 2023-05-30
---

## MySQL DDL 쿼리

<https://0songha0.github.io/plan-design-db/2025-01-08-1>{: target="_blank"}

---

## MySQL DQL 쿼리

### INNER JOIN (=JOIN)
```
SELECT * FROM 테이블1 A
INNER JOIN 테이블2 B ON A.키 = B.폴인키
```
두 테이블에서 조인 조건을 만족하는 행만 결합하여 반환합니다.  
조인 조건을 만족하지 않는 행은 결과에서 제외해서 NULL 값으로 채우지 않으므로, 성능이 개선됩니다.  
테이블1에 2건, 테이블2에 5건 있으면 최소 0건, 최대 5건의 결과가 나올 수 있습니다.  
게시판 댓글을 조회할 때 사용하면 적합합니다.

### LEFT OUTER JOIN (=LEFT JOIN)
```
SELECT * FROM 테이블1 A
LEFT OUTER JOIN 테이블2 B ON A.키 = B.폴인키
```
왼쪽 테이블에 있는 모든 행을 반환하고, 우측 테이블에 조인 조건을 만족하는 데이터가 있으면 결합합니다.  
우측 테이블에 조건에 맞는 데이터가 없으면 NULL 값으로 채워 반환하므로, 불필요한 계산이 있을 수 있습니다.  
테이블1에 2건, 테이블2에 5건 있으면 최소 2건, 최대 5건의 결과가 나올 수 있습니다.

<mark>LEFT JOIN 그룹화</mark>
```
SELECT * FROM 테이블1 A
LEFT OUTER JOIN 테이블2 B ON A.키 = B.폴인키
GROUP BY A.키
```
테이블1에 2건, 테이블2에 5건 있으면 테이블1의 키컬럼 값을 그룹화하여 총 2건의 결과가 나옵니다.  
테이블2의 컬럼 값은 무작위로 선택되어 나타나며, MIN 또는 MAX 함수로 제어할 수 있습니다.

### 전체 테이블 row 수 확인
```
SELECT 
	table_name, 
	table_rows
FROM
	information_schema.tables
WHERE
	table_schema = 'DB명'
AND
	table_rows > 0
ORDER BY table_name;
```

### 숫자형 캐스팅
```
SELECT * FROM 테이블명
WHERE 컬럼명 = CAST(#{파라미터명} AS UNSIGNED)
```
CAST 함수로 파라미터를 숫자 변환 후, 컬럼 값과 일치하면 조회합니다.

### 특정 컬럼 데이터 순으로 정렬
```
ORDER BY FIELD (컬럼명, "1순위", "2순위", "3순위")
```

### 조건에 따른 값 출력
```
SELECT
	CASE
		WHEN 컬럼명='조건1' THEN '값1'
		WHEN 컬럼명='조건2' THEN '값2'
		ELSE '값3'
	END AS '출력컬럼명'
FROM 테이블명
```

### 컬럼 내 JSON 값 추출
```
SELECT
	컬럼명 ->> '$."JSON키"', -- JSON 값에서 양 옆의 ""를 제거하고 출력
	json_extract(컬럼명, '$.JSON키'), -- JSON 값 그대로 출력
	json_value(컬럼명, '$.JSON키') -- JSON 값을 문자열 변환하여 출력
FROM
	테이블명
```

### 여러 컬럼 데이터 병합
```
SELECT
	CONCAT(컬럼명1, 컬럼명2)
FROM
	테이블명
```
여러 컬럼의 데이터를 이어붙여 하나의 문자열로 반환합니다.

### MySQL 페이징
```
SELECT
	*
FROM
	테이블명
WHERE
	조건
LIMIT 페이지당글수 OFFSET 건너뛸글수
또는
LIMIT 건너뛸글수, 페이지당글수
```

### WITH 조회
```
WITH 테이블1명 AS (
	SELECT 쿼리 1
),
테이블2명 AS (
	SELECT 쿼리 2
)
SELECT
	*
FROM
	테이블1명 AS 약칭1
INNER JOIN
	테이블2명 AS 약칭2 ON 약칭1.키 = 약칭2.키
```
결과가 중복 실행될 수 있는 서브쿼리 테이블 대신 WITH 절을 사용하여 조회하면,  
WITH 절 결과를 메모리에 임시 테이블 (CTE) 저장하고 전체 쿼리에서 재사용하므로 간결하고 효율적입니다.  
CTE는 쿼리 실행시간 동안 메모리에 유지되기 때문에, 메모리 사용량이 많아질 수 있습니다.

### 데이터 통계 쿼리
```
SELECT
	t.MBER_ID,
	COUNT(t.MBER_ID) AS ditbCnt
FROM
	시험지테이블 e
INNER JOIN
	과제배포테이블 d ON e.시험지ID = d.시험지ID
	AND e.DEL_YN = 'N'
INNER JOIN
	학생배포테이블 t ON d.과제배포ID = t.과제배포ID
	AND d.DEL_YN = 'N'
	AND t.DEL_YN = 'N'
WHERE 
	d.교과서ID = #{교과서ID}
AND
	d.클래스ID = #{클래스ID}
GROUP BY t.MBER_ID
```
학생별 배포된 시험지 수 통계 조회 쿼리 예시입니다.

---

## MySQL 인덱스 관련 쿼리

### 테이블 인덱스 조회 쿼리
```
SHOW INDEX FROM 테이블명;
```
- Key_name : PK 인덱스는 PRIMARY, 논클러스터드 인덱스는 인덱스명으로 표현
- Seq_in_index : 인덱스 내에 현재 컬럼이 포함된 순서
- Column_name : 인덱스가 적용된 컬럼명
- Cardnality : 선택도 (선택도가 높은 = 유니크한 값이 많은 컬럼에 인덱스를 걸면 쿼리 성능이 더 좋습니다.)

### 인덱스 생성 쿼리
```
CREATE INDEX 인덱스명 ON 테이블명 (컬럼명);
-- 인덱스명 예시 : idx_테이블명_컬럼명1_컬럼명2 또는 idx_테이블명_순번
```
테이블 잠금이 발생할 수 있으므로, 운영 중 인덱스 생성은 지양해야 합니다.  
논클러스터드 인덱스 추가 시 테이블 데이터와 별도로 저장되며, 물리적인 데이터 정렬과는 무관합니다.

### 인덱스 삭제 쿼리
```
DROP INDEX 인덱스명 ON 테이블명;
```

---

## MySQL DML 쿼리

### 데이터 INSERT문
```
INSERT INTO 테이블명 (
	컬럼명1,
	컬럼명2
) VALUES (
	'값1',
	'값2'
);
```

<mark>INSERT INTO DB명.테이블명 시 에러</mark>
```
SQL Error [1142] [42000]: (conn=1043447) INSERT command denied to user 'DB명'@'10.0.0.4' for table '테이블명'
```
개발 DB명과 운영 DB명이 다른 경우, 쿼리에 DB명이 들어가면 위와 같은 에러가 날 수 있습니다.  
쿼리에서 DB명을 제거하고, 'INSERT INTO 테이블명'으로 실행하면 됩니다.

### UPDATE 문
```
UPDATE 테이블명
SET 컬럼명 = '변경값'
WHERE 컬럼명 = '값'
```
조회 조건에 해당하는 row에 대해 컬럼 값을 변경합니다.

### JOIN으로 조회된 행 DELETE
```
DELTE    
	a
FROM
	테이블1 a
INNER JOIN
	테이블2 b
ON
	b.키열 = a.키열
WHERE
	b.열 = '값'
```
DELETE문 실행 전에는 항상 FROM 이하 구문을 SELECT 해서 어떤 데이터를 삭제하는지 확인해야 합니다.

---

## MySQL 설정

### MySQL 타임아웃 설정 방법
```
SET GLOBAL max_execution_time=30000;
-- 최대 쿼리 실행 시간 (밀리초)

SET GLOBAL wait_timeout=30;
-- 비대화형 유휴 연결 타임아웃 (초)

SET GLOBAL interactive_timeout=30;
-- 대화형 터미널 세션 타임아웃 (초)
```
DBMS 자체 타임아웃 설정 방법입니다.  
JDBC 타임아웃 설정이 더 일반적이나, 둘 다 설정하는 것이 안전합니다.

<mark>MySQL DB 타임아웃 시간 확인</mark>
```
SHOW VARIABLES LIKE 'max_execution_time';
```
DB 쿼리 타임아웃 시간을 확인하는 쿼리입니다.

---

## MySQL DB 정보 확인

### DB 목록 조회
```
show databases
```
DB 서버에 속한 모든 DB 이름을 조회할 수 있습니다.

### MySQL 쓰레드 조회 쿼리
<mark>활성 쓰레드 수</mark>
```
SHOW STATUS LIKE 'Threads_connected';
```
현재 연결된 클라이언트 수를 보여줍니다.

<mark>현재 실행 중 쓰레드 수</mark>
```
SHOW STATUS LIKE 'Threads_running';
```
현재 연결된 클라이언트 중, 대기하는 클라이언트를 제외하고 쿼리를 실행 중인 클라이언트 수만 보여줍니다.

<mark>최대 쓰레드 수</mark>
```
SHOW VARIABLES LIKE 'max_connections';
```
1,000개 연결 허용 시 최소 1GB 이상의 메모리가 필요하며, CPU 과부하 발생을 고려하여 적절한 설정이 필요합니다.

<mark>현재 모든 쓰레드 상태</mark>
```
SHOW PROCESSLIST;
```
각 쓰레드의 Id, User, Host, Command, State, Time, Info 정보가 포함됩니다.  
어떤 쿼리가 실행 중인지, 어떤 상태인지 등을 확인할 수 있습니다.

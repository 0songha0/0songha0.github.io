---
title: "리눅스 톰캣 설치 및 실행 / 톰캣 설정 및 로그 확인 / DB 연결 방법"
excerpt: ""

categories:
  - 운영 / 리눅스
tags:
  - []

permalink: /op/2023-02-17-1

toc: true
toc_sticky: true

date: 2023-02-17
last_modified_at: 2023-02-17
---

## 리눅스 톰캣 설치 방법

### 톰캣, JDK 설치 파일 준비
리눅스 서버에서 인터넷 연결이 된다면 wget 명령어로 직접 설치해도 됩니다.

<mark>JDK 설치 파일 준비</mark>  
윈도우에서 jdk-11.0.2_linux-x64_bin.tar.gz 파일을 다운 받고,  
파일질라로 리눅스 서버의 유저 home 폴더에 올립니다.

<mark>톰캣 설치 파일 준비</mark>  
윈도우에서 apache-tomcat-9.0.56.tar.gz 파일을 다운 받고,  
파일질라로 리눅스 서버의 유저 home 폴더에 올립니다.

### 톰캣 설치 방법
<mark>톰캣 압축 해제</mark>  
```bash
tar xzf apache-tomcat-9.0.56.tar.gz
```
PuTTY로 접속하여 유저 home 폴더에서 위 명령어로 압축을 해제합니다.

<mark>톰캣 폴더 이동</mark>  
```bash
sudo mv apache-tomcat-9.0.56 /usr/local/tomcat-9.0
```
압축 해제한 톰캣 폴더를 이동시키며, 폴더명을 짧게 변경합니다.

### JDK 설치 방법
<mark>JDK 압축 해제</mark>  
```bash
tar xzf jdk-11.0.2_linux-x64_bin.tar.gz
```

<mark>JDK 폴더 이동</mark>  
```bash
sudo mv jdk-11.0.2_linux-x64_bin /usr/local/jdk-11
```
압축 해제한 JDK 폴더를 이동시키며, 폴더명을 짧게 변경합니다.

---

## 톰캣 설정 방법

### 리눅스 환경설정 파일 편집
```bash
sudo vi /etc/profile
```
profile 파일 가장 하단에 아래와 같이 JDK, 톰캣 경로 설정 후 저장합니다.
```yml
export JAVA_HOME=/usr/local/jdk-11
export CATALINA_HOME=/usr/local/tomcat-9.0
export CLASSPATH=.:$JAVA_HOME/jre/lib/ext:$JAVA_HOME/lib/tools.jar:$CATALINA_HOME/lib/jsp-api.jar:$CATALINA_HOME/lib/servlet-api.jar
PATH=$PATH:$JAVA_HOME/bin:$CATALINA_HOME/bin
```

### 리눅스 환경변수 적용
```bash
source /etc/profile
```
위 명령어를 입력해야 변경된 profile 파일이 리눅스 서버에 반영됩니다.

<mark>JAVA_HOME 확인</mark>
```bash
java -version
javac -version
```

---

## 톰캣 실행
```bash
/톰캣경로/bin/startup.sh
```
톰캣 실행 시 war 파일이 압축 해제된 ROOT또는프로젝트 폴더 소스가 반영됩니다.

<mark>root 계정으로 톰캣 실행하지 않은 경우 에러메세지</mark>
```
Using CATALINA_BASE:   /톰캣경로
Using CATALINA_HOME:   /톰캣경로
Using CATALINA_TMPDIR: /톰캣경로/temp
Using JRE_HOME:        /usr/local/jdk-11
Using CLASSPATH:       /톰캣경로/bin/bootstrap.jar:/톰캣경로/bin/tomcat-juli.jar
Using CATALINA_OPTS:
touch: cannot touch ‘/톰캣경로/logs/catalina.out’: Permission denied
/톰캣경로/bin/catalina.sh: line 504: /톰캣경로/logs/catalina.out: Permission denied
Neither the JAVA_HOME nor the JRE_HOME environment variable is defined
At least one of these environment variable is needed to run this program
```

<mark>JAVA_HOME 환경변수 경로 확인 방법</mark>
```
echo $JAVA_HOME
```
JAVA_HOME JDK 버전(11)에 비해 빌드한 프로젝트 JAVA 버전(17)이 너무 높은 경우, URL 접속 시 404에러가 날 수 있습니다.

---

## 톰캣 실행 확인
```bash
ps -ef | grep tomcat
```

<mark>톰캣 실행중 상태</mark>
```
root      3023     1  0 Jan27 ?        00:33:10 /usr/local/jdk-11/bin/java -Djava.util.logging.config.file=/톰캣경로/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /톰캣경로/bin/bootstrap.jar:/톰캣경로/bin/tomcat-juli.jar -Dcatalina.base=/톰캣경로 -Dcatalina.home=/톰캣경로 -Djava.io.tmpdir=/톰캣경로/temp org.apache.catalina.startup.Bootstrap start
ec2-user 17265 17140  0 02:31 pts/0    00:00:00 grep --color=auto tomcat
```

<mark>톰캣 종료 상태</mark>
```
ec2-user 17301 17140  0 02:33 pts/0    00:00:00 grep --color=auto tomcat
```

---

## 톰캣 실시간 로그 확인
```bash
tail -1000f /톰캣경로/logs/catalina.out
```
사용자 요청에 대한 로그를 실시간으로 볼 수 있습니다.  
각 서버별로 PuTTY를 하나 더 띄워서 로그를 열어두면 모니터링이 더 편합니다.

### 톰캣 로그 레벨 변경
```bash
cd /톰캣경로/webapps/프로젝트폴더명/WEB-INF/classes
vi log4j2.xml
```
전자정부프레임워크 기준으로 egovframework, org.egovframe, jdbc.sqltiming, org.springframework.web.servlet.view 등의 Logger level을 DEBUG로 변경하면 로그가 더 상세히 나옵니다.

### log4j2 로그 경로 설정
```xml
<RollingFile name="file" fileName="/DATA/log4j/프로젝트명/system.log" filePattern="/DATA/log4j/프로젝트명/system.log.%d{yyyy-MM-dd-hh}">
  <PatternLayout pattern="%d %5p [%c] %m%n"/>
  <Policies>
    <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
  </Policies>
</RollingFile>
```
/톰캣경로/webapps/프로젝트폴더명/WEB-INF/classes/log4j2.xml 파일에서 RollingFile 태그의 fileName은 서버에 위치한 log4j system.log 파일이어야 합니다.

---

## 프로젝트 폴더 소유자 변경
```bash
sudo chown -R 유저명:유저명 ROOT또는프로젝트명
```
root 계정 소유 폴더는 파일질라에서 다른 계정으로 접속 시 조회가 되지 않습니다.  
위 명령어로 소유자를 변경해두면 다른 계정에서도 접근 가능합니다.  
보안상 개발서버에서만 소유자를 root 외 계정의 유저로 설정하는 것이 좋습니다.


---








톰캣 실행
/usr/local/tomcat-9.0/bin/startup.sh


톰캣 접속 테스트

http:// 서버외부IP또는로드밸런서IP:포트 URL 접속 시 아래와 같은 화면이 나오면 정상 설치된 것입니다.

80 포트는 생략이 가능합니다





리눅스 서버 내부에서 톰캣 연결 확인

curl localhost




로그인 시 톰캣 에러 로그 해결
Caused by: java.lang.RuntimeException: Driver net.sf.log4jdbc.sql.jdbcapi.DriverSpy claims to not accept jdbcUrl, jdbc:log4jdbc:mariadb://DB서버명.ck39dp9w2h39.ap-northeast-2.rds.amazonaws.com:3306/innodb?serverTimezone=UTC&characterEncoding=UTF-8&autoReconnect=true&validationQuery=select 1
        at cohttp://m.zaxxer.hikari.util.DriverDataSource.<init>(DriverDataSource.java:110)
        at cohttp://m.zaxxer.hikari.pool.PoolBase.initializeDataSource(PoolBase.java:331)
        at cohttp://m.zaxxer.hikari.pool.PoolBase.<init>(PoolBase.java:114)
        at cohttp://m.zaxxer.hikari.pool.HikariPool.<init>(HikariPool.java:108)
        at cohttp://m.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:112)
        at org.springframework.jdbc.datasource.DataSourceUtils.fetchConnection(DataSourceUtils.java:159)
        at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:117)
        at org.springframework.jdbc.datasource.DataSourceUtils.getConnection(DataSourceUtils.java:80)
        at org.mybatis.spring.transaction.SpringManagedTransaction.openConnection(SpringManagedTransaction.java:80)
        at org.mybatis.spring.transaction.SpringManagedTransaction.getConnection(SpringManagedTransaction.java:67)
        at org.apache.ibatis.executor.BaseExecutor.getConnection(BaseExecutor.java:337)
        at org.apache.ibatis.executor.SimpleExecutor.prepareStatement(SimpleExecutor.java:86)
        at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:62)
        at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:325)
        at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:156)
        at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:109)
        at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:89)
        at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:151)
        ... 70 more
위와 같이, DB 연결이 안되면 log4jdbc.log4j2.properties 파일 위치를 WEB-INF/classes 폴더 안으로 옮겨주면 됩니다.







톰캣 DB 정보 설정


이클립스, 서버 모두 아래의 설정으로 MariaDB에 연결할 수 있었다.



server.xml

<GlobalNamingResources>
	<Resource auth="Container" factory="org.apache.tomcat.dbcp.dbcp2.BasicDataSourceFactory" driverClassName="com.mysql.jdbc.Driver" global="jdbc/DB명" maxTotal="20" maxIdle="10" maxWait="-1" name="jdbc/DB명" type="javax.sql.DataSource" url="jdbc:mysql://DB서버IP:3306/DB명?characterEncoding=UTF-8" username="유저명" password="비밀번호" validationQuery="select 1"/>
</GlobalNamingResources>


context.xml

<Context>
	<ResourceLink global="jdbc/DB명" name="jdbc/DB명" type="javax.sql.DataSource"></ResourceLink>
</Context>






톰캣 server.xml 설정

vi /usr/local/tomcat-9.0/conf/server.xml
ROOT 폴더만 사용하는 경우는 별도의 server.xml 설정이 필요하지 않다.

여러 프로젝트를 하나의 톰캣에 올리는 경우 아래 설정의 Service를 프로젝트 수만큼 넣어줘야 한다.

  <Service name="Catalina2">
    <Connector port="8081" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" />
    <Engine name="Catalina" defaultHost="localhost">
    <Realm className="org.apache.catalina.realm.LockOutRealm">
    <Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase"/>
    </Realm>
    <Host name="localhost"  appBase="webapps" unpackWARs="true" autoDeploy="true">
    <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs" prefix="localhost_access_log" suffix=".txt" pattern="%h %l %u %t &quot;%r&quot; %s %b" />
    <Context docBase="프로젝트폴더명" path="URL시작경로" reloadable="true" sessionCookiePath="/"/>
    </Host>
    </Engine>
  </Service>
각 서비스의 서비스명, Connector 포트, docBase(프로젝트 폴더명)은 중복되지 않게 수정이 필요하다.









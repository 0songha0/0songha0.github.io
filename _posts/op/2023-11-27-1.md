---
title: "리눅스 톰캣 WAR 수동 배포 방법 / 개발서버, 운영서버 반영 방법 (작성중)"
excerpt: ""

categories:
  - 운영 / 테스트
tags:
  - []

permalink: /op/2023-11-27-1

toc: true
toc_sticky: true

date: 2023-11-27
last_modified_at: 2023-11-27
---

## 개발서버 WAR 수동 배포 방법

개발서버는 어드민, 사용자 서비스가 한 프로젝트에 있는 경우라면, 하나의 톰캣에 단일 war로 올려도 좋습니다.

### 기존 소스 백업
기존 프로젝트 소스는 파일질라로 node_modules처럼 무거운 폴더 제외하고 내려받아서 날짜 폴더에 백업해두는 것이 좋습니다.

### ROOT 계정으로 전환
```bash
sudo su -
```
별도의 설정을 하지 않았다면, 톰캣 실행은 root 계정으로만 가능하니 미리 root 계정으로 변경합니다.

### 톰캣 종료
```bash
cd /톰캣경로/bin
./shutdown.sh
```
다시 war를 푸는 과정에서 데이터나 소스가 꼬이지 않게, 기존 실행중이던 톰캣 서비스를 종료합니다.

### 기존 프로젝트 소스, war 삭제
```bash
cd /usr/local/tomcat-9.0/webapps
rm -rf ROOT또는프로젝트명/*
rm -rf ROOT또는프로젝트명.war
```
기존 war 파일이 있다면, 같은 이름이라 업로드가 안될 수 있으니 삭제합니다.

### 파일질라로 war 업로드
<mark>war 파일 이름 변경</mark>
<table>
  <tbody>
    <tr>
      <td>톰캣 하나에 프로젝트 하나만 올리는 경우</td>
      <td>ROOT.war</td>
    </tr>
    <tr>
      <td>톰캣 하나에 여러 프로젝트 올리는 경우</td>
      <td>프로젝트명.war</td>
    </tr>
  </tbody>
</table>
톰캣 실행 중 webapps 폴더 안에 war를 올리면 자동으로 압축 해제되니 미리 이름을 변경해서 올리면 좋습니다.

<mark>war 업로드 경로</mark>
```
/usr/local/tomcat-9.0/webapps
```

### war 압축 해제
```bash
unzip ROOT또는프로젝트명.war -d ROOT또는프로젝트명
```

---

## 운영서버 WAR 수동 배포 방법

FTP로는 root 계정이 아니면 운영서버 톰캣의 webapps 폴더에 접근할 수 없기 때문에 개발서버 배포와 절차가 다릅니다.

운영서버는 관리자, 사용자 서비스가 한 프로젝트에 있어도 두 개의 톰캣에 분리하여 각각의 war로 배포하는 것이 좋습니다.  
관리자 서비스에 문제가 있어도 사용자 서비스에 영향을 미치지 않게 하기 위함입니다.

대부분의 운영서버는 was 서버가 이중화되어 있기 때문에, 모든 was 서버의 톰캣에 동일하게 배포해야 합니다.  
모든 was 서버의 톰캣 로그를 열어두고, URL로 서비스 접속하여 어떤 톰캣에 붙었는 지 확인 후 그 톰캣 먼저 반영해서 테스트 시 정상이면 다른 톰캣에도 반영하는 것도 방법입니다.


### 기존 소스 백업
작성 예정

### war 파일 업로드
작성예정



### ROOT 계정으로 전환
```bash
sudo su -
```
톰캣 webapps 폴더 접근이 root 계정으로만 가능하기 때문에 계정을 변경합니다.



작성예정

---

## 단건 수동 반영 방법

### 프론트 파일 배포
css, js, jsp 등 프론트 파일은 wabapps 폴더 이하에서 같은 경로 파일을 교체하면, war 배포 및 톰캣 재실행 없이도 적용됩니다.

### Java Class 파일 배포
Java 컴파일 결과물인 Class 파일은 /톰캣경로/webapps/프로젝트폴더명/WEB-INF/classes 이하에서 같은 경로 파일을 교체하고 톰캣 재실행 시 반영됩니다.

---

### 톰캣 실행
```bash
cd /usr/local/tomcat-9.0/bin
./startup.sh
```

<mark>root 계정으로 톰캣 실행하지 않은 경우 에러메세지</mark>
```
Using CATALINA_BASE:   /usr/local/tomcat-9.0
Using CATALINA_HOME:   /usr/local/tomcat-9.0
Using CATALINA_TMPDIR: /usr/local/tomcat-9.0/temp
Using JRE_HOME:        /usr/local/jdk-11
Using CLASSPATH:       /usr/local/tomcat-9.0/bin/bootstrap.jar:/usr/local/tomcat-9.0/bin/tomcat-juli.jar
Using CATALINA_OPTS:
touch: cannot touch ‘/usr/local/tomcat-9.0/logs/catalina.out’: Permission denied
/usr/local/tomcat-9.0/bin/catalina.sh: line 504: /usr/local/tomcat-9.0/logs/catalina.out: Permission denied
Neither the JAVA_HOME nor the JRE_HOME environment variable is defined
At least one of these environment variable is needed to run this program
```

<mark>JAVA_HOME 환경변수 경로 확인 방법</mark>
```
echo $JAVA_HOME
```
JAVA_HOME JDK 버전(11)에 비해 빌드한 프로젝트 JAVA 버전(17)이 너무 높은 경우, URL 접속 시 404에러가 날 수 있습니다.

---

## 톰캣 실행 확인
```bash
ps -ef | grep tomcat
```

<mark>톰캣 실행중 상태</mark>
```
root      3023     1  0 Jan27 ?        00:33:10 /usr/local/jdk-11/bin/java -Djava.util.logging.config.file=/usr/local/tomcat-9.0/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /usr/local/tomcat-9.0/bin/bootstrap.jar:/usr/local/tomcat-9.0/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat-9.0 -Dcatalina.home=/usr/local/tomcat-9.0 -Djava.io.tmpdir=/usr/local/tomcat-9.0/temp org.apache.catalina.startup.Bootstrap start
ec2-user 17265 17140  0 02:31 pts/0    00:00:00 grep --color=auto tomcat
```

<mark>톰캣 종료 상태</mark>
```
ec2-user 17301 17140  0 02:33 pts/0    00:00:00 grep --color=auto tomcat
```

---

## 톰캣 실시간 로그 확인
```bash
tail -1000f /톰캣경로/logs/catalina.out
```
사용자 요청에 대한 로그를 실시간으로 볼 수 있습니다.  
각 서버별로 PuTTY를 하나 더 띄워서 로그를 열어두면 모니터링이 더 편합니다.

### 톰캣 로그 레벨 변경
```bash
cd /톰캣경로/webapps/프로젝트폴더명/WEB-INF/classes
vi log4j2.xml
```
전자정부프레임워크 기준으로 egovframework, org.egovframe, jdbc.sqltiming, org.springframework.web.servlet.view 등의 Logger level을 DEBUG로 변경하면 로그가 더 상세히 나옵니다.

### log4j2 로그 경로 설정
```xml
<RollingFile name="file" fileName="/DATA/log4j/프로젝트명/system.log" filePattern="/DATA/log4j/프로젝트명/system.log.%d{yyyy-MM-dd-hh}">
  <PatternLayout pattern="%d %5p [%c] %m%n"/>
  <Policies>
    <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
  </Policies>
</RollingFile>
```
/톰캣경로/webapps/프로젝트폴더명/WEB-INF/classes/log4j2.xml 파일에서 RollingFile 태그의 fileName은 서버에 위치한 log4j system.log 파일이어야 합니다.

---

## 프로젝트 폴더 소유자 변경
```bash
sudo chown -R 유저명:유저명 ROOT또는프로젝트명
```
root 계정 소유 폴더는 파일질라에서 다른 계정으로 접속 시 조회가 되지 않습니다.  
위 명령어로 소유자를 변경해두면 다른 계정에서도 접근 가능합니다.  
보안상 개발서버에서만 소유자를 root 외 계정의 유저로 설정하는 것이 좋습니다.
